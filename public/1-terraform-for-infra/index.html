<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Hugo 0.132.2">
    <meta name="description" content="">
<meta name="author" content="journeyoftheaverageguy@gmail.com">

    <link rel="icon" href="/images/favicon.png" type="image/png">

    <title>Using Terraform to Deploy Infrastructure on AWS :: AWS Account Setup</title>

    
    <link href="/css/nucleus.css?1724581330" rel="stylesheet">
    <link href="/css/fontawesome-all.min.css?1724581330" rel="stylesheet">
    <link href="/css/hybrid.css?1724581330" rel="stylesheet">
    <link href="/css/featherlight.min.css?1724581330" rel="stylesheet">
    <link href="/css/perfect-scrollbar.min.css?1724581330" rel="stylesheet">
    <link href="/css/auto-complete.css?1724581330" rel="stylesheet">
    <link href="/css/atom-one-dark-reasonable.css?1724581330" rel="stylesheet">
    <link href="/css/theme.css?1724581330" rel="stylesheet">
    <link href="/css/hugo-theme.css?1724581330" rel="stylesheet">
    
    <link href="/css/theme-workshop.css?1724581330" rel="stylesheet">
    
    

    <script src="/js/jquery-3.3.1.min.js?1724581330"></script>

    <style>
      :root #header + #content > #left > #rlblock_left{
          display:none !important;
      }
      
    </style>
    
  </head>
  <body class="" data-url="/1-terraform-for-infra/">
    <nav id="sidebar" class="showVisitedLinks">



  <div id="header-wrapper">
    <div id="header">
      <a id="logo" href="/">

<svg id="Layer_1" data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 60 30" width="30%"><defs><style>.cls-1{fill:#fff;}.cls-2{fill:#f90;fill-rule:evenodd;}</style></defs><title>AWS-Logo_White-Color</title><path class="cls-1" d="M14.09,10.85a4.7,4.7,0,0,0,.19,1.48,7.73,7.73,0,0,0,.54,1.19.77.77,0,0,1,.12.38.64.64,0,0,1-.32.49l-1,.7a.83.83,0,0,1-.44.15.69.69,0,0,1-.49-.23,3.8,3.8,0,0,1-.6-.77q-.25-.42-.51-1a6.14,6.14,0,0,1-4.89,2.3,4.54,4.54,0,0,1-3.32-1.19,4.27,4.27,0,0,1-1.22-3.2A4.28,4.28,0,0,1,3.61,7.75,6.06,6.06,0,0,1,7.69,6.46a12.47,12.47,0,0,1,1.76.13q.92.13,1.91.36V5.73a3.65,3.65,0,0,0-.79-2.66A3.81,3.81,0,0,0,7.86,2.3a7.71,7.71,0,0,0-1.79.22,12.78,12.78,0,0,0-1.79.57,4.55,4.55,0,0,1-.58.22l-.26,0q-.35,0-.35-.52V2a1.09,1.09,0,0,1,.12-.58,1.2,1.2,0,0,1,.47-.35A10.88,10.88,0,0,1,5.77.32,10.19,10.19,0,0,1,8.36,0a6,6,0,0,1,4.35,1.35,5.49,5.49,0,0,1,1.38,4.09ZM7.34,13.38a5.36,5.36,0,0,0,1.72-.31A3.63,3.63,0,0,0,10.63,12,2.62,2.62,0,0,0,11.19,11a5.63,5.63,0,0,0,.16-1.44v-.7a14.35,14.35,0,0,0-1.53-.28,12.37,12.37,0,0,0-1.56-.1,3.84,3.84,0,0,0-2.47.67A2.34,2.34,0,0,0,5,11a2.35,2.35,0,0,0,.61,1.76A2.4,2.4,0,0,0,7.34,13.38Zm13.35,1.8a1,1,0,0,1-.64-.16,1.3,1.3,0,0,1-.35-.65L15.81,1.51a3,3,0,0,1-.15-.67.36.36,0,0,1,.41-.41H17.7a1,1,0,0,1,.65.16,1.4,1.4,0,0,1,.33.65l2.79,11,2.59-11A1.17,1.17,0,0,1,24.39.6a1.1,1.1,0,0,1,.67-.16H26.4a1.1,1.1,0,0,1,.67.16,1.17,1.17,0,0,1,.32.65L30,12.39,32.88,1.25A1.39,1.39,0,0,1,33.22.6a1,1,0,0,1,.65-.16h1.54a.36.36,0,0,1,.41.41,1.36,1.36,0,0,1,0,.26,3.64,3.64,0,0,1-.12.41l-4,12.86a1.3,1.3,0,0,1-.35.65,1,1,0,0,1-.64.16H29.25a1,1,0,0,1-.67-.17,1.26,1.26,0,0,1-.32-.67L25.67,3.64,23.11,14.34a1.26,1.26,0,0,1-.32.67,1,1,0,0,1-.67.17Zm21.36.44a11.28,11.28,0,0,1-2.56-.29,7.44,7.44,0,0,1-1.92-.67,1,1,0,0,1-.61-.93v-.84q0-.52.38-.52a.9.9,0,0,1,.31.06l.42.17a8.77,8.77,0,0,0,1.83.58,9.78,9.78,0,0,0,2,.2,4.48,4.48,0,0,0,2.43-.55,1.76,1.76,0,0,0,.86-1.57,1.61,1.61,0,0,0-.45-1.16A4.29,4.29,0,0,0,43,9.22l-2.41-.76A5.15,5.15,0,0,1,38,6.78a3.94,3.94,0,0,1-.83-2.41,3.7,3.7,0,0,1,.45-1.85,4.47,4.47,0,0,1,1.19-1.37A5.27,5.27,0,0,1,40.51.29,7.4,7.4,0,0,1,42.6,0a8.87,8.87,0,0,1,1.12.07q.57.07,1.08.19t.95.26a4.27,4.27,0,0,1,.7.29,1.59,1.59,0,0,1,.49.41.94.94,0,0,1,.15.55v.79q0,.52-.38.52a1.76,1.76,0,0,1-.64-.2,7.74,7.74,0,0,0-3.2-.64,4.37,4.37,0,0,0-2.21.47,1.6,1.6,0,0,0-.79,1.48,1.58,1.58,0,0,0,.49,1.18,4.94,4.94,0,0,0,1.83.92L44.55,7a5.08,5.08,0,0,1,2.57,1.6A3.76,3.76,0,0,1,47.9,11a4.21,4.21,0,0,1-.44,1.93,4.4,4.4,0,0,1-1.21,1.47,5.43,5.43,0,0,1-1.85.93A8.25,8.25,0,0,1,42.05,15.62Z"></path><path class="cls-2" d="M45.19,23.81C39.72,27.85,31.78,30,25,30A36.64,36.64,0,0,1,.22,20.57c-.51-.46-.06-1.09.56-.74A49.78,49.78,0,0,0,25.53,26.4,49.23,49.23,0,0,0,44.4,22.53C45.32,22.14,46.1,23.14,45.19,23.81Z"></path><path class="cls-2" d="M47.47,21.21c-.7-.9-4.63-.42-6.39-.21-.53.06-.62-.4-.14-.74,3.13-2.2,8.27-1.57,8.86-.83s-.16,5.89-3.09,8.35c-.45.38-.88.18-.68-.32C46.69,25.8,48.17,22.11,47.47,21.21Z"></path></svg>

</a>

    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fas fa-search"></i></label>
    <input data-search-input id="search-by" type="search" placeholder="Search...">
    <span data-search-clear=""><i class="fas fa-times"></i></span>
</div>

<script type="text/javascript" src="/js/lunr.min.js?1724581330"></script>
<script type="text/javascript" src="/js/auto-complete.js?1724581330"></script>
<script type="text/javascript">
    
        var baseurl = "\/\/localhost:1313\/";
    
</script>
<script type="text/javascript" src="/js/search.js?1724581330"></script>

    
  </div>

    <div class="highlightable">
    <ul class="topics">

        
          
          




 
  
    
    <li data-nav-id="/1-terraform-for-infra/" title="Using Terraform to Deploy Infrastructure on AWS" class="dd-item 
        
        active
        
        ">
      <a href="/1-terraform-for-infra/">
          <b>1. </b>Using Terraform to Deploy Infrastructure on AWS
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/2-k8s-with-kubespray-ansible/" title="Using Kubespray and Ansible to Deploy a Kubernetes Cluster" class="dd-item 
        
        
        
        ">
      <a href="/2-k8s-with-kubespray-ansible/">
          <b>2. </b>Using Kubespray and Ansible to Deploy a Kubernetes Cluster
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            




 
  
    
    <li data-nav-id="/2-k8s-with-kubespray-ansible/1-bastion-configuration/" title="Configuring the Bastion Instance" class="dd-item 
        
        
        
        ">
      <a href="/2-k8s-with-kubespray-ansible/1-bastion-configuration/">
          <b>2.1. </b>Configuring the Bastion Instance
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/2-k8s-with-kubespray-ansible/2-kube-spray/" title="Installing the K8s Cluster with Kubespray and Ansible" class="dd-item 
        
        
        
        ">
      <a href="/2-k8s-with-kubespray-ansible/2-kube-spray/">
          <b>2.2. </b>Installing the K8s Cluster with Kubespray and Ansible
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/3-clean-up/" title="Cleaning Up Resources" class="dd-item 
        
        
        
        ">
      <a href="/3-clean-up/">
          <b>3. </b>Cleaning Up Resources
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
         
    </ul>

    
    
      <section id="shortcuts">
        <h3>More</h3>
        <ul>
          
              <li> 
                  <a class="padding" href="https://www.facebook.com/groups/awsstudygroupfcj/"><i class='fab fa-facebook'></i> AWS Study Group</a>
              </li>
          
        </ul>
      </section>
    

    
    <section id="prefooter">
      <hr/>
      <ul>
      
        <li>
          <a class="padding">
            <i class="fas fa-language fa-fw"></i>
          <div class="select-style">
            <select id="select-language" onchange="location = this.value;">
          
          
          
              
              
                  
                    
                    
                      <option id="en" value="//localhost:1313/1-terraform-for-infra/" selected>English</option>
                    
                  
              
                  
              
          
              
              
                  
              
                  
                    
                    
                      <option id="vi" value="//localhost:1313/vi/1-terraform-for-infra/">Tiếng Việt</option>
                    
                  
              
          
        </select>
        <svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
          width="255px" height="255px" viewBox="0 0 255 255" style="enable-background:new 0 0 255 255;" xml:space="preserve">
          <g>
            <g id="arrow-drop-down">
              <polygon points="0,63.75 127.5,191.25 255,63.75 		" />
            </g>
          </g>
        </svg>
        </div>
        </a>
        </li>
      
      
      
        <li><a class="padding" href="#" data-clear-history-toggle=""><i class="fas fa-history fa-fw"></i> Clear History</a></li>
      
      </ul>
    </section>
    
    <section id="footer">
      <left>
    
     <b> Workshop</b> <br>
    <img src="https://hitwebcounter.com/counter/counter.php?page=7830891&style=0038&nbdigits=9&type=page&initCount=0" title="Migrate" Alt="web counter"   border="0" /></a>  <br>
     <b> <a href="https://cloudjourney.awsstudygroup.com/">Cloud Journey</a></b> <br>
    <img src="https://hitwebcounter.com/counter/counter.php?page=7830807&style=0038&nbdigits=9&type=page&initCount=0" title="Total CLoud Journey" Alt="web counter"   border="0"   />
     
</left>
<left>
    <br>
    <br>
        <b> Last Updated </b> <br>
        <i><font color=orange>14-10-2021</font></i>
    </left>
    <left>
        <br>
        <br>
            <b> Team </b> <br>
           
            <i>
                <a href="https://www.linkedin.com/in/jotaguy"  style="color:orange">Gia Hưng</a>
        </i>
        </left>

<script async defer src="https://buttons.github.io/buttons.js"></script>

    </section>
  </div>
</nav>




        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fas fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fas fa-list-alt"></i></span>
                  
                  <span class="links">
                 
                 
                    
          
          
            
            
          
          
            <a href='/'>Deploying a Kubernetes Cluster on AWS with Terraform and Ansible</a> > Using Terraform to Deploy Infrastructure on AWS
          
        
          
        
                 
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li></li>
      </ul>
    </li>
  </ul>
</nav>
    </div>
</div>

                
              </div>
            </div>
            
        <div id="head-tags">
        
        </div>
        
        <div id="body-inner">
          
            <h1>
              
              Using Terraform to Deploy Infrastructure on AWS
            </h1>
          

        



	<p><strong>Contents:</strong></p>
<ul>
<li><a href="/1-terraform-for-infra/#structure-of-terraform-configuration-files">Structure of Terraform Configuration Files</a></li>
<li><a href="/1-terraform-for-infra/#configuration-files">Configuration files</a></li>
<li><a href="/1-terraform-for-infra/#apply-cấu-hình-lên-aws">Apply cấu hình lên AWS</a></li>
</ul>
<h4 id="structure-of-terraform-configuration-files">Structure of Terraform Configuration Files</h4>

<div class="notices note" ><p>Since this LAB focuses only on manually deploying a Kubernetes Cluster, I won&rsquo;t go into detail about Terraform or Ansible. If you want to learn more about these tools, you can find many excellent and detailed guides on sites like Medium or Viblo VN.</p>
</div>

<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-plaintext" data-lang="plaintext"><span style="display:flex;"><span>terraform/
</span></span><span style="display:flex;"><span>│
</span></span><span style="display:flex;"><span>├── 0-provider.tf         # Configuration file to define the Cloud Provider you will use Terraform to deploy
</span></span><span style="display:flex;"><span>├── 1-vpc.tf              # Defines the configuration for AWS VPC
</span></span><span style="display:flex;"><span>├── 2-instances.tf        # Defines the configuration for AWS EC2 Instances
</span></span><span style="display:flex;"><span>├── 3-security-groups.tf  # Defines security groups
</span></span><span style="display:flex;"><span>├── 4-load-balancers.tf  # Configures Load Balancing for Master Nodes
</span></span><span style="display:flex;"><span>├── 5-vars.tf             # Defines variables used in .tf files
</span></span><span style="display:flex;"><span>├── 6-key.tf              # Configures the creation of SSH key for SSH access to Bastion Instance
</span></span><span style="display:flex;"><span>├── 7-output.tf           # Configuration for output after apply
</span></span></code></pre></div><h4 id="configuration-files">Configuration files</h4>
<p>File <code>0-provider.tf</code>:</p>
<ul>
<li>This file defines the Cloud Provider (in this case AWS) with which Terraform will interact with its resources. It sets up the required provider and specifies the region (region) of AWS where the resources will be exploited.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-terraform" data-lang="terraform"><span style="display:flex;"><span><span style="color:#66d9ef">provider</span> <span style="color:#e6db74">&#34;aws&#34;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">region</span> = var.<span style="color:#a6e22e">region</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">terraform</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">required_providers</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">aws</span> = {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">source</span>  = <span style="color:#e6db74">&#34;hashicorp/aws&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">version</span> = <span style="color:#e6db74">&#34;~&gt; 5.0&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>File <code>1-vpc.tf</code>:</p>
<ul>
<li>This is a Terraform file used to deploy a VPC, which stands for &ldquo;Virtual Private Cloud&rdquo; on the AWS environment.</li>
<li>With Terraform, you can define the components of a VPC such as network, subnets, internet gateway, NAT gateway, security groups, etc. However, in this LAB, I will use a publicly available module from the <a href="https://registry.terraform.io/?product_intent=terraform">Terraform Registry</a> and only need to adjust the attribute values according to the module&rsquo;s documentation to customize the VPC as needed.
<ul>
<li>For example:
<ul>
<li><strong>single_nat_gateway = true</strong>: means that all subnets will use a single NAT gateway; by default, this module will create one NAT gateway per subnet.</li>
<li><strong>cidr</strong>: Defines the CIDR block for the VPC, which is the IP address range that the VPC can use. For example: &ldquo;10.0.0.0/16&rdquo; allows you to use IP addresses from 10.0.0.0 to 10.0.255.255.</li>
<li><strong>azs</strong>: List of Availability Zones where you will deploy subnets in the VPC (such as us-east-1a, us-east-1b, us-east-1c,&hellip;). This ensures high availability and load balancing for the resources.</li>
<li>Other attributes and options can be found in the documentation of each module on the <a href="https://registry.terraform.io/?product_intent=terraform">Terraform Registry</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-terraform" data-lang="terraform"><span style="display:flex;"><span><span style="color:#66d9ef">module</span> <span style="color:#e6db74">&#34;vpc&#34;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">source</span> = <span style="color:#e6db74">&#34;terraform-aws-modules/vpc/aws&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">name</span> = <span style="color:#e6db74">&#34;self-managed-k8s-vpc&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">cidr</span> = <span style="color:#e6db74">&#34;10.0.0.0/16&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">azs</span>             = var.<span style="color:#a6e22e">availability_zones</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">private_subnets</span> = var.<span style="color:#a6e22e">private_subnets</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">public_subnets</span>  = var.<span style="color:#a6e22e">public_subnets</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">enable_nat_gateway</span> = <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">single_nat_gateway</span> = <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">one_nat_gateway_per_az</span> = <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">map_public_ip_on_launch</span> = <span style="color:#66d9ef">true</span><span style="color:#75715e">    //assign public ip for BASTION instance
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">tags</span> = {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Terraform</span> = <span style="color:#e6db74">&#34;true&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Environment</span> = <span style="color:#e6db74">&#34;dev&#34;</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>File <code>2-instances.tf</code>:</p>

<div class="notices warning" ><p>Make sure to create instances with at least <strong>1 CPU và 2GB RAM</strong> otherwise, you may encounter resource errors during the K8s installation process.</p>
</div>

<ul>
<li>This file will define the configurations related to <strong>instances</strong>, including the <strong>Bastion Instance</strong>, <strong>Master Nodes</strong> and <strong>Worker Nodes</strong></li>
<li>For example:
<ul>
<li><strong>ami_id</strong>            :lThe ID of the &ldquo;image&rdquo; that your EC2 instances will use, such as Linux, Ubuntu, CentOS, etc.</li>
<li><strong>instance_type</strong>     :The configuration of the EC2 instances you want to deploy, such as <strong>t2.micro, t2.small, t3.medium, t3.large,&hellip;</strong></li>
<li><strong>subnet_id</strong>         :The subnet ID where the EC2 instance will be located.</li>
<li><strong>security_groups</strong>   :The IDs of the security groups that need to be assigned to the instance.</li>
<li><strong>key_name</strong>          :The name of the SSH key to be imported into the instance.</li>
<li><strong>user_data</strong> :c      :Configuration to import the SSH key into the instance.</li>
</ul>
</li>
</ul>

<div class="notices note" ><p>In this LAB, I use Terraform to generate an SSH key and import it into the Bastion Instance. In practice, you can also create a key on AWS and assign it to the instance or create a key on your local machine and then import the public key into the instance&rsquo;s user data after successfully deploying the infrastructure with Terraform.</p>
</div>

<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-terraform" data-lang="terraform"><span style="display:flex;"><span><span style="color:#75715e">// Bastion Instance
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">resource</span> <span style="color:#e6db74">&#34;aws_instance&#34;</span> <span style="color:#e6db74">&#34;bastion&#34;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">ami</span>                         = var.<span style="color:#a6e22e">ami_id</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">instance_type</span>               = var.<span style="color:#a6e22e">bastion_instance_type</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">subnet_id</span>                   = module.<span style="color:#a6e22e">vpc</span>.<span style="color:#a6e22e">public_subnets</span>[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">associate_public_ip_address</span> = <span style="color:#e6db74">&#34;true&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">security_groups</span>             = [<span style="color:#a6e22e">aws_security_group</span>.<span style="color:#a6e22e">allow_ssh</span>.<span style="color:#a6e22e">id</span>]
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">key_name</span>                    =   <span style="color:#a6e22e">aws_key_pair</span>.<span style="color:#a6e22e">k8_ssh</span>.<span style="color:#a6e22e">key_name</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">user_data</span> = <span style="color:#f92672">&lt;&lt;-EOF</span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                #!bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                echo &#34;PubkeyAcceptedKeyTypes=+ssh-rsa&#34; &gt;&gt; /etc/ssh/sshd_config.d/10-insecure-rsa-keysig.conf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                systemctl reload sshd
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                echo &#34;${tls_private_key.ssh.private_key_pem}&#34; &gt;&gt; /home/ubuntu/.ssh/id_rsa
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                chown ubuntu /home/ubuntu/.ssh/id_rsa
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                chgrp ubuntu /home/ubuntu/.ssh/id_rsa
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                chmod 600   /home/ubuntu/.ssh/id_rsa
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                echo &#34;starting ansible install&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                apt-add-repository ppa:ansible/ansible -y
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                apt update
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                apt install ansible -y
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                </span><span style="color:#f92672">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">tags</span> = {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Name</span> = <span style="color:#e6db74">&#34;Bastion&#34;</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}<span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//  Master Nodes
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">resource</span> <span style="color:#e6db74">&#34;aws_instance&#34;</span> <span style="color:#e6db74">&#34;masters&#34;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">count</span>           = var.<span style="color:#a6e22e">master_node_count</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">ami</span>             = var.<span style="color:#a6e22e">ami_id</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">instance_type</span>   = var.<span style="color:#a6e22e">master_instance_type</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">subnet_id</span>       = <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">element</span>(module.<span style="color:#a6e22e">vpc</span>.<span style="color:#a6e22e">private_subnets</span>, count.<span style="color:#a6e22e">index</span>)<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">key_name</span>        = <span style="color:#a6e22e">aws_key_pair</span>.<span style="color:#a6e22e">k8_ssh</span>.<span style="color:#a6e22e">key_name</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">security_groups</span> = [<span style="color:#a6e22e">aws_security_group</span>.<span style="color:#a6e22e">k8_nondes</span>.<span style="color:#a6e22e">id</span>, <span style="color:#a6e22e">aws_security_group</span>.<span style="color:#a6e22e">k8_masters</span>.<span style="color:#a6e22e">id</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">tags</span> = {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Name</span> = format(<span style="color:#e6db74">&#34;k8s-master-%02d&#34;</span>, count.<span style="color:#a6e22e">index</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}<span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//  Worker Nodes
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">resource</span> <span style="color:#e6db74">&#34;aws_instance&#34;</span> <span style="color:#e6db74">&#34;workers&#34;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">count</span>           = var.<span style="color:#a6e22e">worker_node_count</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">ami</span>             = var.<span style="color:#a6e22e">ami_id</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">instance_type</span>   = var.<span style="color:#a6e22e">worker_instance_type</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">subnet_id</span>       = <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">element</span>(module.<span style="color:#a6e22e">vpc</span>.<span style="color:#a6e22e">private_subnets</span>, count.<span style="color:#a6e22e">index</span>)<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">key_name</span>        = <span style="color:#a6e22e">aws_key_pair</span>.<span style="color:#a6e22e">k8_ssh</span>.<span style="color:#a6e22e">key_name</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">security_groups</span> = [<span style="color:#a6e22e">aws_security_group</span>.<span style="color:#a6e22e">k8_nondes</span>.<span style="color:#a6e22e">id</span>, <span style="color:#a6e22e">aws_security_group</span>.<span style="color:#a6e22e">k8_workers</span>.<span style="color:#a6e22e">id</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">tags</span> = {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Name</span> = format(<span style="color:#e6db74">&#34;k8s-worker-%02d&#34;</span>, count.<span style="color:#a6e22e">index</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>File <code>3-security_groups.tf</code>:</p>
<ul>
<li>This section will configure the Security Groups needed for the VPC:
<ul>
<li>SG to allow SSH access to the Bastion Instance</li>
<li>SGs required for the Kubernetes Cluster, master nodes, and worker nodes</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-terraform" data-lang="terraform"><span style="display:flex;"><span><span style="color:#66d9ef">resource</span> <span style="color:#e6db74">&#34;aws_security_group&#34;</span> <span style="color:#e6db74">&#34;allow_ssh&#34;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">name</span>        = <span style="color:#e6db74">&#34;allow_ssh&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">description</span> = <span style="color:#e6db74">&#34;Allow ssh inbound traffic&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">vpc_id</span>    = module.<span style="color:#a6e22e">vpc</span>.<span style="color:#a6e22e">vpc_id</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ingress</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">from_port</span>   = <span style="color:#ae81ff">22</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">to_port</span>     = <span style="color:#ae81ff">22</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">protocol</span>    = <span style="color:#e6db74">&#34;tcp&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">cidr_blocks</span> = [<span style="color:#e6db74">&#34;0.0.0.0/0&#34;</span>]
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ingress</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">from_port</span>   = <span style="color:#ae81ff">-1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">to_port</span>     = <span style="color:#ae81ff">-1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">protocol</span>    = <span style="color:#e6db74">&#34;icmp&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">cidr_blocks</span> = [<span style="color:#e6db74">&#34;0.0.0.0/0&#34;</span>]
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">egress</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">from_port</span>   = <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">to_port</span>     = <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">protocol</span>    = <span style="color:#e6db74">&#34;-1&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">cidr_blocks</span> = [<span style="color:#e6db74">&#34;0.0.0.0/0&#34;</span>]
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">resource</span> <span style="color:#e6db74">&#34;aws_security_group&#34;</span> <span style="color:#e6db74">&#34;k8_nondes&#34;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">name</span> = <span style="color:#e6db74">&#34;k8_nodes&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">description</span> = <span style="color:#e6db74">&#34;sec group for k8 nodes&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">vpc_id</span> = module.<span style="color:#a6e22e">vpc</span>.<span style="color:#a6e22e">vpc_id</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ingress</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">from_port</span>   = <span style="color:#ae81ff">22</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">to_port</span>     = <span style="color:#ae81ff">22</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">protocol</span>    = <span style="color:#e6db74">&#34;tcp&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">cidr_blocks</span> = [<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>var.<span style="color:#a6e22e">vpc_cidr</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>]
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ingress</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">from_port</span>   = <span style="color:#ae81ff">-1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">to_port</span>     = <span style="color:#ae81ff">-1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">protocol</span>    = <span style="color:#e6db74">&#34;icmp&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">cidr_blocks</span> = [<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>var.<span style="color:#a6e22e">vpc_cidr</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>]
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">egress</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">from_port</span>   = <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">to_port</span>     = <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">protocol</span>    = <span style="color:#e6db74">&#34;-1&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">cidr_blocks</span> = [<span style="color:#e6db74">&#34;0.0.0.0/0&#34;</span>]
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">resource</span> <span style="color:#e6db74">&#34;aws_security_group&#34;</span> <span style="color:#e6db74">&#34;k8_masters&#34;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">name</span> = <span style="color:#e6db74">&#34;k8_masters&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">description</span> = <span style="color:#e6db74">&#34;sec group for k8 master nodes&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">vpc_id</span> = module.<span style="color:#a6e22e">vpc</span>.<span style="color:#a6e22e">vpc_id</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ingress</span> {<span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        #Kubernetes API server
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">from_port</span>   = <span style="color:#ae81ff">6443</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">to_port</span>     = <span style="color:#ae81ff">6443</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">protocol</span>    = <span style="color:#e6db74">&#34;tcp&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">cidr_blocks</span> = [<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>var.<span style="color:#a6e22e">vpc_cidr</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>]
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ingress</span> {<span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        #etcd server client API
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">from_port</span>   = <span style="color:#ae81ff">2379</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">to_port</span>     = <span style="color:#ae81ff">2380</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">protocol</span>    = <span style="color:#e6db74">&#34;tcp&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">cidr_blocks</span> = [<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>var.<span style="color:#a6e22e">vpc_cidr</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>]
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ingress</span> {<span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        #Kubelet API
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">from_port</span>   = <span style="color:#ae81ff">10250</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">to_port</span>     = <span style="color:#ae81ff">10250</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">protocol</span>    = <span style="color:#e6db74">&#34;tcp&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">cidr_blocks</span> = [<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>var.<span style="color:#a6e22e">vpc_cidr</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>]
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ingress</span> {<span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        #kube-scheduler
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">from_port</span>   = <span style="color:#ae81ff">10259</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">to_port</span>     = <span style="color:#ae81ff">10259</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">protocol</span>    = <span style="color:#e6db74">&#34;tcp&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">cidr_blocks</span> = [<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>var.<span style="color:#a6e22e">vpc_cidr</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>]
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ingress</span> {<span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        #kube-controller-manager
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">from_port</span>   = <span style="color:#ae81ff">10257</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">to_port</span>     = <span style="color:#ae81ff">10257</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">protocol</span>    = <span style="color:#e6db74">&#34;tcp&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">cidr_blocks</span> = [<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>var.<span style="color:#a6e22e">vpc_cidr</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>]
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">resource</span> <span style="color:#e6db74">&#34;aws_security_group&#34;</span> <span style="color:#e6db74">&#34;k8_workers&#34;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">name</span> = <span style="color:#e6db74">&#34;k8_workers&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">description</span> = <span style="color:#e6db74">&#34;sec group for k8 worker nodes&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">vpc_id</span> = module.<span style="color:#a6e22e">vpc</span>.<span style="color:#a6e22e">vpc_id</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ingress</span> {<span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        #Kubelet API
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">from_port</span>   = <span style="color:#ae81ff">10250</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">to_port</span>     = <span style="color:#ae81ff">10250</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">protocol</span>    = <span style="color:#e6db74">&#34;tcp&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">cidr_blocks</span> = [<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>var.<span style="color:#a6e22e">vpc_cidr</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>]
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ingress</span> {<span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        #NodePort Services†
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">from_port</span>   = <span style="color:#ae81ff">30000</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">to_port</span>     = <span style="color:#ae81ff">32767</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">protocol</span>    = <span style="color:#e6db74">&#34;tcp&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">cidr_blocks</span> = [<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>var.<span style="color:#a6e22e">vpc_cidr</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>]
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>File <code>4-load-balancers.tf</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-terraform" data-lang="terraform"><span style="display:flex;"><span><span style="color:#66d9ef">
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">resource</span> <span style="color:#e6db74">&#34;aws_lb&#34;</span> <span style="color:#e6db74">&#34;k8_masters_lb&#34;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">name</span>        = <span style="color:#e6db74">&#34;k8-masters-lb&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">internal</span>    = <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">load_balancer_type</span> = <span style="color:#e6db74">&#34;network&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">subnets</span> = module.<span style="color:#a6e22e">vpc</span>.<span style="color:#a6e22e">private_subnets</span><span style="color:#75715e"> #[for subnet in module.vpc.private_subnets : subnet.id]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">tags</span> = {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Terraform</span> = <span style="color:#e6db74">&#34;true&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Environment</span> = <span style="color:#e6db74">&#34;dev&#34;</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">resource</span> <span style="color:#e6db74">&#34;aws_lb_target_group&#34;</span> <span style="color:#e6db74">&#34;k8_masters_api&#34;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">name</span> = <span style="color:#e6db74">&#34;k8-masters-api&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">port</span> = <span style="color:#ae81ff">6443</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">protocol</span> = <span style="color:#e6db74">&#34;TCP&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">vpc_id</span> = module.<span style="color:#a6e22e">vpc</span>.<span style="color:#a6e22e">vpc_id</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">target_type</span> = <span style="color:#e6db74">&#34;ip&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">health_check</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">port</span>      = <span style="color:#ae81ff">6443</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">protocol</span>  = <span style="color:#e6db74">&#34;TCP&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">interval</span>  = <span style="color:#ae81ff">30</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">healthy_threshold</span> = <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">unhealthy_threshold</span> = <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">resource</span> <span style="color:#e6db74">&#34;aws_lb_listener&#34;</span> <span style="color:#e6db74">&#34;k8_masters_lb_listener&#34;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">load_balancer_arn</span> = <span style="color:#a6e22e">aws_lb</span>.<span style="color:#a6e22e">k8_masters_lb</span>.<span style="color:#a6e22e">arn</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">port</span> = <span style="color:#ae81ff">6443</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">protocol</span> = <span style="color:#e6db74">&#34;TCP&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">default_action</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">target_group_arn</span> = <span style="color:#a6e22e">aws_lb_target_group</span>.<span style="color:#a6e22e">k8_masters_api</span>.<span style="color:#a6e22e">id</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">type</span> = <span style="color:#e6db74">&#34;forward&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">resource</span> <span style="color:#e6db74">&#34;aws_lb_target_group_attachment&#34;</span> <span style="color:#e6db74">&#34;k8_masters_attachment&#34;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">count</span> = length(<span style="color:#a6e22e">aws_instance</span>.<span style="color:#a6e22e">masters</span>.<span style="color:#f92672">*</span>.<span style="color:#a6e22e">id</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">target_group_arn</span> = <span style="color:#a6e22e">aws_lb_target_group</span>.<span style="color:#a6e22e">k8_masters_api</span>.<span style="color:#a6e22e">arn</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">target_id</span> = <span style="color:#a6e22e">aws_instance</span>.<span style="color:#a6e22e">masters</span>.<span style="color:#f92672">*</span>.<span style="color:#a6e22e">private_ip</span>[count.<span style="color:#a6e22e">index</span>]
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>File <code>5-vars.tf</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-terraform" data-lang="terraform"><span style="display:flex;"><span><span style="color:#66d9ef">
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">variable</span> <span style="color:#e6db74">&#34;region&#34;</span> {
</span></span><span style="display:flex;"><span>   <span style="color:#a6e22e">default</span> = <span style="color:#e6db74">&#34;us-east-1&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">variable</span> <span style="color:#e6db74">&#34;ami_id&#34;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">type</span> = <span style="color:#a6e22e">string</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">default</span> = <span style="color:#e6db74">&#34;ami-04a81a99f5ec58529&#34;</span><span style="color:#75715e">   // Ubuntu 24.04 LTS
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">variable</span> <span style="color:#e6db74">&#34;availability_zones&#34;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">type</span>    = list(<span style="color:#a6e22e">string</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">default</span> = [<span style="color:#e6db74">&#34;us-east-1a&#34;</span>, <span style="color:#e6db74">&#34;us-east-1b&#34;</span>, <span style="color:#e6db74">&#34;us-east-1c&#34;</span>]
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">variable</span> <span style="color:#e6db74">&#34;vpc_cidr&#34;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">type</span> = <span style="color:#a6e22e">string</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">default</span> = <span style="color:#e6db74">&#34;10.0.0.0/16&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">variable</span> <span style="color:#e6db74">&#34;private_subnets&#34;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">type</span> = list(<span style="color:#a6e22e">string</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">default</span> = [<span style="color:#e6db74">&#34;10.0.1.0/24&#34;</span>, <span style="color:#e6db74">&#34;10.0.2.0/24&#34;</span>, <span style="color:#e6db74">&#34;10.0.3.0/24&#34;</span>]
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">variable</span> <span style="color:#e6db74">&#34;public_subnets&#34;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">type</span> = list(<span style="color:#a6e22e">string</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">default</span> = [<span style="color:#e6db74">&#34;10.0.101.0/24&#34;</span>, <span style="color:#e6db74">&#34;10.0.102.0/24&#34;</span>, <span style="color:#e6db74">&#34;10.0.103.0/24&#34;</span>]
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">variable</span> <span style="color:#e6db74">&#34;master_node_count&#34;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">type</span> = <span style="color:#a6e22e">number</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">default</span> = <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">variable</span> <span style="color:#e6db74">&#34;worker_node_count&#34;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">type</span> = <span style="color:#a6e22e">number</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">default</span> = <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">variable</span> <span style="color:#e6db74">&#34;ssh_user&#34;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">type</span> = <span style="color:#a6e22e">string</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">default</span> = <span style="color:#e6db74">&#34;ubuntu&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">variable</span> <span style="color:#e6db74">&#34;bastion_instance_type&#34;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">type</span> = <span style="color:#a6e22e">string</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">default</span> = <span style="color:#e6db74">&#34;t3.micro&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">variable</span> <span style="color:#e6db74">&#34;master_instance_type&#34;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">type</span> = <span style="color:#a6e22e">string</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">default</span> = <span style="color:#e6db74">&#34;t3.small&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">variable</span> <span style="color:#e6db74">&#34;worker_instance_type&#34;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">type</span> = <span style="color:#a6e22e">string</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">default</span> = <span style="color:#e6db74">&#34;t3.small&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>File <code>6-key.tf</code>:</p>
<ul>
<li>Use Terraform to generate an SSH key for SSH access to the Bastion Instance.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-terraform" data-lang="terraform"><span style="display:flex;"><span><span style="color:#66d9ef">resource</span> <span style="color:#e6db74">&#34;tls_private_key&#34;</span> <span style="color:#e6db74">&#34;ssh&#34;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">algorithm</span> = <span style="color:#e6db74">&#34;RSA&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">rsa_bits</span>  = <span style="color:#ae81ff">4096</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">resource</span> <span style="color:#e6db74">&#34;local_file&#34;</span> <span style="color:#e6db74">&#34;k8_ssh_key&#34;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">filename</span>                = <span style="color:#e6db74">&#34;k8_ssh_key.pem&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">file_permission</span>         = <span style="color:#e6db74">&#34;600&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">directory_permission</span>    = <span style="color:#e6db74">&#34;700&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">content</span>                 = <span style="color:#a6e22e">tls_private_key</span>.<span style="color:#a6e22e">ssh</span>.<span style="color:#a6e22e">private_key_pem</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">resource</span> <span style="color:#e6db74">&#34;aws_key_pair&#34;</span> <span style="color:#e6db74">&#34;k8_ssh&#34;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">key_name</span>   = <span style="color:#e6db74">&#34;k8_ssh&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">public_key</span> = <span style="color:#a6e22e">tls_private_key</span>.<span style="color:#a6e22e">ssh</span>.<span style="color:#a6e22e">public_key_openssh</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>File <code>7-outputs.tf</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-terraform" data-lang="terraform"><span style="display:flex;"><span><span style="color:#66d9ef">resource</span> <span style="color:#e6db74">&#34;tls_private_key&#34;</span> <span style="color:#e6db74">&#34;ssh&#34;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">algorithm</span> = <span style="color:#e6db74">&#34;RSA&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">rsa_bits</span>  = <span style="color:#ae81ff">4096</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">resource</span> <span style="color:#e6db74">&#34;local_file&#34;</span> <span style="color:#e6db74">&#34;k8_ssh_key&#34;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">filename</span>                = <span style="color:#e6db74">&#34;k8_ssh_key.pem&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">file_permission</span>         = <span style="color:#e6db74">&#34;600&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">directory_permission</span>    = <span style="color:#e6db74">&#34;700&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">content</span>                 = <span style="color:#a6e22e">tls_private_key</span>.<span style="color:#a6e22e">ssh</span>.<span style="color:#a6e22e">private_key_pem</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">resource</span> <span style="color:#e6db74">&#34;aws_key_pair&#34;</span> <span style="color:#e6db74">&#34;k8_ssh&#34;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">key_name</span>   = <span style="color:#e6db74">&#34;k8_ssh&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">public_key</span> = <span style="color:#a6e22e">tls_private_key</span>.<span style="color:#a6e22e">ssh</span>.<span style="color:#a6e22e">public_key_openssh</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="apply-cấu-hình-lên-aws">Apply cấu hình lên AWS</h4>
<ul>
<li>
<p>After configuring the Terraform files, use the commands <strong>terraform init</strong> and <strong>terraform apply</strong> to apply the resource configurations to the AWS infrastructure.
<img alt="Image" src="/images/1-terraform/terraform-init.PNG"></p>
</li>
<li>
<p>Successful apply results</p>
</li>
</ul>
<p><img alt="Image" src="/images/1-terraform/terraform-apply.PNG"></p>
<p><img alt="Image" src="/images/1-terraform/aws-instances.PNG"></p>





<footer class=" footline" >
	
</footer>

        
        </div> 
        

      </div>

    <div id="navigation">
        
        
        
        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
        
        


	 
	 
		
			<a class="nav nav-prev" href="/" title="Deploying a Kubernetes Cluster on AWS with Terraform and Ansible"> <i class="fa fa-chevron-left"></i></a>
		
		
			<a class="nav nav-next" href="/2-k8s-with-kubespray-ansible/" title="Using Kubespray and Ansible to Deploy a Kubernetes Cluster" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
		
	
    </div>

    </section>
    
    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="/js/clipboard.min.js?1724581330"></script>
    <script src="/js/perfect-scrollbar.min.js?1724581330"></script>
    <script src="/js/perfect-scrollbar.jquery.min.js?1724581330"></script>
    <script src="/js/jquery.sticky.js?1724581330"></script>
    <script src="/js/featherlight.min.js?1724581330"></script>
    <script src="/js/highlight.pack.js?1724581330"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="/js/modernizr.custom-3.6.0.js?1724581330"></script>
    <script src="/js/learn.js?1724581330"></script>
    <script src="/js/hugo-learn.js?1724581330"></script>

    <link href="/mermaid/mermaid.css?1724581330" rel="stylesheet" />
    <script src="/mermaid/mermaid.js?1724581330"></script>
    <script>
        mermaid.initialize({ startOnLoad: true });
    </script>
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-158079754-2', 'auto');
  ga('send', 'pageview');

</script>
  </body>
</html>
